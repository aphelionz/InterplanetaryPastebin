<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="ipfs-api">
  <script>
    Polymer({
      is: "ipfs-api",

      properties: {
        urlBase: {
          type: String,
          value: "http://127.0.0.1:5001/api/v0"
        }
      },

      getFile: function(e) {
        this.ipfs.get(e.detail).then(function(objstream) {
          chunks = '';

          objstream.on('data', function (obj) {
            obj.content.on('data', function(e,f,b) {
              chunks += e.toString();
            })
          });
          objstream.on('end', function () {
            document.body.dispatchEvent(new CustomEvent('file-read', { detail: chunks }));
          });
        }).catch(function(err) {
          console.log(err);
        })
      },

      getSwarmPeers: function() {
        this.ipfs.swarm.peers().then(function(peers) {
          document.body.dispatchEvent(new CustomEvent('peers', { detail: peers }));
        })
        .catch(function(err) {console.log(err)})
      },

      addFile: function(e) {
        this.ipfs.add([new buffer.Buffer(e.detail)]).then(
          function(result) {
            document.body.dispatchEvent(new CustomEvent('file-added', {
              detail: result[0].hash
            }));
          }.bind(this))
          .catch(function(err) {
            console.log(err)
          })
      },

      ready: function() {
        this.ipfs = IpfsApi('localhost', '5001');

        document.body.addEventListener('get-swarm-peers', this.getSwarmPeers.bind(this));
        document.body.addEventListener('get-file', this.getFile.bind(this));
        document.body.addEventListener('add-file', this.addFile.bind(this));
      }
    })
  </script>
</dom-module>