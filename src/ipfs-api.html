<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="ipfs-api">
  <script>
    "use strict";

    Polymer({
      is: "ipfs-api",

      _fireBodyEvent: function(eventName, detail) {
        document.body.dispatchEvent(new CustomEvent(eventName, { detail }));
      },

      _logError: function(err) {
        console.error(err);
      },

      _processObjectStream: function(objstream) {
        let chunks = '';

        let promise = new Promise((resolve, reject) => {
          objstream.on('data', (obj) => {
            chunks += obj.toString();
          }).once('end', () => {
            resolve(chunks)
          });
        });

        return promise;
      },

      getIpfsID: function(e) {
        ipfs.id()
          .then(this._fireBodyEvent.bind(this, 'ipfs-id'))
          .catch(this._logError);
      },

      getFile: function(e) {
        let eventKey = 'file-read';
        if(e.detail.context) {
          eventKey = 'file-read-' + e.detail.context;
        }

        ipfs.files.cat(e.detail)
          .then(this._processObjectStream)
          .then(this._fireBodyEvent.bind(this, eventKey))
          .catch(this._logError);
      },

      getSwarmPeers: function() {
        ipfs.swarm.peers()
          .then(this._fireBodyEvent.bind(this, 'peers'))
          .catch(this._logError);
      },

      addFile: function(e) {
        ipfs.files.add([new buffer.Buffer(e.detail)])
          .then((response) => response[0].hash)
          .then(this._fireBodyEvent.bind(this, 'file-added'))
          .catch(this._logError);
      },

      ready: function() {
        document.body.addEventListener('get-swarm-peers', this.getSwarmPeers.bind(this));
        document.body.addEventListener('get-ipfs-id', this.getIpfsID.bind(this));
        document.body.addEventListener('get-file', this.getFile.bind(this));
        document.body.addEventListener('add-file', this.addFile.bind(this));
      },

      detached: function() {
        document.body.removeEventListener('get-swarm-peers', this.getSwarmPeers.bind(this));
        document.body.removeEventListener('get-ipfs-id', this.getIpfsID.bind(this));
        document.body.removeEventListener('get-file', this.getFile.bind(this));
        document.body.removeEventListener('add-file', this.addFile.bind(this));
      }
    })
  </script>
</dom-module>