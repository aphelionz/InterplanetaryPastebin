<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="ipfs-api">
  <script>
    Polymer({
      is: "ipfs-api",

      properties: {
        urlBase: {
          type: String,
          value: "http://127.0.0.1:5001/api/v0"
        }
      },

      getFile: function(e) {
        this.ipfs.get(e.detail).then(function(objstream) {
          chunks = '';

          objstream.on('data', function (obj) {
            obj.content.on('data', function(e,f,b) {
              chunks += e.toString();
            })
          });
          objstream.on('end', function () {
            document.body.dispatchEvent(new CustomEvent('file-read', { detail: chunks }));
          });
        }).catch(function(err) {
          console.log(err);
        })
      },

      getSwarmPeers: function(e) {
        this.ipfs.swarm.peers().then(function(peers) {
          document.body.dispatchEvent(new CustomEvent('peers', { detail: peers }));
        })
        .catch(function(err) {console.log(err)})
      },

      writeFile: function(e) {
        var usethisfornow = new Date().getTime();

        this.ipfs.files.write('/' + usethisfornow, [new buffer.Buffer(e.detail)], {create: true}).then(
          function(e,f,b) {
            this.ipfs.files.stat('/' + usethisfornow).then(function(res) {
               document.body.dispatchEvent(new CustomEvent('new-file', { detail: res }));
            })
            .catch(function(err) {
              console.log(err)
            });

//            document.body.dispatchEvent(new CustomEvent('file', { detail: result }));
          }.bind(this))
          .catch(function(err) {
            console.log(err)
          })
      },

      ready: function() {
        this.ipfs = IpfsApi('localhost', '5001');

        document.body.addEventListener('get-swarm-peers', this.getSwarmPeers.bind(this));
        document.body.addEventListener('get-file', this.getFile.bind(this));
        document.body.addEventListener('write-file', this.writeFile.bind(this));
      }
    })
  </script>
</dom-module>