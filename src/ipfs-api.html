<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="ipfs-api">
  <script>
    "use strict";

    Polymer({
      is: "ipfs-api",

      _fireBodyEvent: function(eventName, detail) {
        document.body.dispatchEvent(new CustomEvent(eventName, { detail }));
      },

      _logError: function(err) {
        console.error(err);
      },

      _processObjectStream: function(objstream) {
        let chunks = '';

        objstream.on('data', (obj) => {
          chunks += obj.toString();
        }).once('end', () => {
          this._fireBodyEvent('file-read', chunks);
        });
      },

      getFile: function(e) {
        ipfs.files.cat(e.detail)
          .then((objstream) => this._processObjectStream(objstream))
          .catch(this._logError);
      },

      getSwarmPeers: function() {
        ipfs.swarm.peers()
          .then((peers) => this._fireBodyEvent('peers', peers))
          .catch(this._logError);
      },

      addFile: function(e) {
        ipfs.files.add([new buffer.Buffer(e.detail)])
          .then((result) => this._fireBodyEvent('file-added', result[0].hash))
          .catch(this._logError);
      },

      ready: function() {
        document.body.addEventListener('get-swarm-peers', this.getSwarmPeers.bind(this));
        document.body.addEventListener('get-file', this.getFile.bind(this));
        document.body.addEventListener('add-file', this.addFile.bind(this));
      },

      detached: function() {
        document.body.removeEventListener('get-swarm-peers', this.getSwarmPeers.bind(this));
        document.body.removeEventListener('get-file', this.getFile.bind(this));
        document.body.removeEventListener('add-file', this.addFile.bind(this));
      }
    })
  </script>
</dom-module>